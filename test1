#!/bin/bash
set -euo pipefail

cat > copy.sql <<SQL
USE ROLE ${SNOW_ROLE};
USE WAREHOUSE ${SNOW_WAREHOUSE};
USE DATABASE ${SNOW_DATABASE};
USE SCHEMA ${SNOW_SCHEMA};

REMOVE @~ pattern='^S3_FILESIZES\\.csv$';

PUT file://$PWD/S3_FILESIZES.csv @~ OVERWRITE=TRUE AUTO_COMPRESS=FALSE;

COPY INTO ${SNOW_TABLE}
  FROM @~/S3_FILESIZES.csv
  FILE_FORMAT=(TYPE=CSV SKIP_HEADER=1 FIELD_OPTIONALLY_ENCLOSED_BY='"')
  ON_ERROR=ABORT_STATEMENT;
SQL

snowsql \
  -a "$SNOW_ACCOUNT" -u "$SNOW_USER" -r "$SNOW_ROLE" \
  -w "$SNOW_WAREHOUSE" -d "$SNOW_DATABASE" -s "$SNOW_SCHEMA" \
  --private-key-path "$PRIVATE_KEY_PATH" \
  -o friendly=false -o exit_on_error=true \
  -f copy.sql

