stage('Snowflake: PUT + COPY (user stage, dated file)') {
  steps {
    container('dap-build-tools') {
      withCredentials([sshUserPrivateKey(credentialsId: params.CREDENTIAL_ID, keyFileVariable: 'PRIVATE_KEY_PATH')]) {
        withEnv([
          "SNOW_ACCOUNT=${params.SNOW_ACCOUNT}",
          "SNOW_USER=${params.SNOW_USER}",
          "SNOW_ROLE=${params.SNOW_ROLE}",
          "SNOW_WAREHOUSE=${params.SNOW_WH}",
          "SNOW_DATABASE=${params.SNOW_DB}",
          "SNOW_SCHEMA=${params.SNOW_SCHEMA}",
          "SNOW_TABLE=${params.SNOW_TABLE}",
          "CODE_DATE=${params.CODE_DATE ?: ''}",
          "CSV_PREFIX=${params.CSV_PREFIX ?: 'S3_FILESIZES'}",
          "FORCE_COPY=${params.FORCE_COPY ?: 'TRUE'}"
        ]) {
          sh '''#!/bin/bash
set -euo pipefail

: "${CODE_DATE:=}"
: "${CSV_PREFIX:=S3_FILESIZES}"
: "${FORCE_COPY:=TRUE}"

CSV_PATH="${CSV_PREFIX}${CODE_DATE:+_${CODE_DATE}}.csv"
FILE_BASENAME="$(basename "$CSV_PATH")"

command -v snowsql >/dev/null 2>&1 || { echo "snowsql not found in PATH"; exit 127; }
if command -v dos2unix >/dev/null 2>&1; then
  dos2unix -q "$CSV_PATH" || true
fi
[[ -f "$CSV_PATH" ]] || { echo "CSV file not found: $CSV_PATH"; ls -la; exit 66; }

echo "Using CSV_PATH=$CSV_PATH ; FILE_BASENAME=$FILE_BASENAME ; FORCE_COPY=$FORCE_COPY"

cat > copy.sql <<__SQL__
USE ROLE ${SNOW_ROLE};
USE WAREHOUSE ${SNOW_WAREHOUSE};
USE DATABASE ${SNOW_DATABASE};
USE SCHEMA ${SNOW_SCHEMA};

SELECT CURRENT_ROLE() role, CURRENT_WAREHOUSE() wh, CURRENT_DATABASE() db, CURRENT_SCHEMA() sch;

REMOVE @~ pattern='^${FILE_BASENAME//./\\\\.}$';

PUT file://$PWD/${CSV_PATH} @~ OVERWRITE=TRUE AUTO_COMPRESS=FALSE;

COPY INTO ${SNOW_TABLE}
  FROM @~/${FILE_BASENAME}
  FILE_FORMAT=(TYPE=CSV SKIP_HEADER=1 FIELD_OPTIONALLY_ENCLOSED_BY='\"')
  ON_ERROR=ABORT_STATEMENT
  FORCE=${FORCE_COPY};

SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));

SELECT * FROM ${SNOW_TABLE} ORDER BY 1 DESC LIMIT 5;
__SQL__

echo "===== copy.sql (head) ====="
sed -n '1,40p' copy.sql || true
echo "===== end ====="

snowsql \
  -a "$SNOW_ACCOUNT" -u "$SNOW_USER" -r "$SNOW_ROLE" \
  -w "$SNOW_WAREHOUSE" -d "$SNOW_DATABASE" -s "$SNOW_SCHEMA" \
  --private-key-path "$PRIVATE_KEY_PATH" \
  -o friendly=false -o exit_on_error=true \
  -f copy.sql

echo "Loaded ${FILE_BASENAME} (CODE_DATE=${CODE_DATE:-N/A}) into ${SNOW_DATABASE}.${SNOW_SCHEMA}.${SNOW_TABLE} with FORCE=${FORCE_COPY}"
'''
        }
      }
    }
  }
  post {
    success {
      echo "Loaded ${env.CSV_PREFIX}${env.CODE_DATE ? '_' + env.CODE_DATE : ''}.csv into ${params.SNOW_DB}.${params.SNOW_SCHEMA}.${params.SNOW_TABLE}"
    }
  }
}
