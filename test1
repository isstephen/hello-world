
WITH cob AS (
  SELECT MAX(COB_DAY_DATE) AS cob_date
  FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.V_INT_COB_DAYS
),


bill_raw AS (
  SELECT
    bd.ARRANGEMENT_ID,
    COALESCE(
      TRY_TO_DATE(TO_VARCHAR(bd.PAYMENT_DATE),'YYYY-MM-DD'),
      TRY_TO_DATE(TO_VARCHAR(bd.PAYMENT_DATE),'YYYYMMDD'),
      TRY_TO_DATE(TO_VARCHAR(bd.MIS_DATE    ),'YYYY-MM-DD'),
      TRY_TO_DATE(TO_VARCHAR(bd.MIS_DATE    ),'YYYYMMDD')
    ) AS PAYMENT_DATE,
    UPPER(TRIM(COALESCE(bd.PAYMENT_TYPE, bd.BILL_TYPE, ''))) AS PAYMENT_TYPE,
    UPPER(TRIM(bd.PROPERTY))                                  AS PROPERTY,
    TRY_TO_DECIMAL(REGEXP_REPLACE(TO_VARCHAR(bd.OR_PROP_AMOUNT),'[^0-9\\.-]',''),38,2) AS OR_PROP_AMOUNT_N
  FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.BNK_AA_BILL_DETAILS bd
),


gross_by_arr AS (
  SELECT
    ARRANGEMENT_ID,
    PAYMENT_DATE,
    SUM(OR_PROP_AMOUNT_N) AS INTEREST_GROSS_AMT
  FROM bill_raw, cob
  WHERE PAYMENT_DATE = cob.cob_date
    AND PAYMENT_TYPE  LIKE 'INTEREST%'
    AND PROPERTY LIKE '%DEPOSITINT%'           
    AND PROPERTY NOT LIKE '%TAX%'              
    AND PROPERTY NOT LIKE '%CFS%'              
    AND PROPERTY NOT LIKE '%COMM%'             
  GROUP BY 1,2
),


arrangement_base AS (
  SELECT ARRANGEMENT_ID, ACTIVE_PRODUCT AS PRODUCT_ID
  FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.BNK_AA_ARRANGEMENT
),
arr_account_latest AS (
  SELECT
    SPLIT_PART(ARRANGEMENT_KEY,'-',1) AS ARRANGEMENT_ID,
    ALT_ID
  FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.BNK_AA_ARR_ACCOUNT, cob
  WHERE UPPER(COALESCE(ALT_ID_TYPE,'')) IN ('BNZ.ACC.NO','BNZ.IBS')
    AND COALESCE(
          TRY_TO_DATE(SPLIT_PART(SPLIT_PART(ARRANGEMENT_KEY,'-',3),'.',1),'YYYYMMDD'),
          MIS_DATE::DATE
        ) <= cob.cob_date
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY SPLIT_PART(ARRANGEMENT_KEY,'-',1)
    ORDER BY MIS_DATE DESC
  ) = 1
)

SELECT
  g.ARRANGEMENT_ID,
  a.PRODUCT_ID,
  acc.ALT_ID,
  g.PAYMENT_DATE,
  g.INTEREST_GROSS_AMT
FROM gross_by_arr g
LEFT JOIN arrangement_base  a   USING (ARRANGEMENT_ID)
LEFT JOIN arr_account_latest acc USING (ARRANGEMENT_ID)
WHERE g.INTEREST_GROSS_AMT <> 0
ORDER BY g.INTEREST_GROSS_AMT DESC NULLS LAST
LIMIT 30;
