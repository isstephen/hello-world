/* ===========================================================
   ACTUAL_INTEREST_BILL_AMOUNTS  
   - Product id 
   - ALT ID  
   - Payment Date 
   - Interest Gross Amount 
   =========================================================== */

CREATE OR REPLACE VIEW DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.ACTUAL_INTEREST_BILL_GROSS AS
WITH
cob AS (
  SELECT MAX(COB_DAY_DATE) AS cob_date
  FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.V_INT_COB_DAYS
),
arrangement_base AS (
  SELECT a.ARRANGEMENT_ID, a.ACTIVE_PRODUCT
  FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.BNK_AA_ARRANGEMENT a
  WHERE (UPPER(a.ACTIVE_PRODUCT) LIKE 'TD.%'
         OR UPPER(a.ACTIVE_PRODUCT) LIKE 'DEPOSITS%')
    AND UPPER(a.ARR_STATUS) IN ('CURRENT','PENDING_CLOSURE')
    AND NOT EXISTS (
      SELECT 1
      FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.BNK_AA_BNZ_BREAK_DETAILS b
      WHERE b.ARRANGEMENT_ID = a.ARRANGEMENT_ID
        AND UPPER(TRIM(b.BRK_REASON)) = 'WITHDRAW'
        AND UPPER(TRIM(COALESCE(b.BREAK_CANCELLED,'NO'))) = 'YES'
    )
),
arr_account_latest AS (
  SELECT
    SPLIT_PART(aa.ARRANGEMENT_KEY,'-',1) AS ARRANGEMENT_ID,
    aa.ALT_ID AS ALT_ID
  FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.BNK_AA_ARR_ACCOUNT aa, cob
  WHERE UPPER(COALESCE(aa.ALT_ID_TYPE,'')) IN ('BNZ.IBS','BNZ.ACC.NO')
    AND COALESCE(
          TRY_TO_DATE(SPLIT_PART(SPLIT_PART(aa.ARRANGEMENT_KEY,'-',3),'.',1),'YYYYMMDD'),
          aa.MIS_DATE::DATE
        ) <= cob.cob_date
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY SPLIT_PART(aa.ARRANGEMENT_KEY,'-',1)
    ORDER BY aa.MIS_DATE DESC
  ) = 1
),
bill_raw AS (
  SELECT
    bd.ARRANGEMENT_ID,
    COALESCE(TRY_TO_DATE(bd.PAYMENT_DATE::STRING,'YYYY-MM-DD'), bd.MIS_DATE::DATE) AS PAYMENT_DATE,
    UPPER(COALESCE(bd.PAYMENT_TYPE, bd.BILL_TYPE, ''))                              AS PAYMENT_TYPE,
    UPPER(COALESCE(bd.PROPERTY_NAME, bd.PROPERTY, bd.PROP_NAME, ''))                AS PROPERTY,
    TRY_TO_DECIMAL(REGEXP_REPLACE(bd.OR_PROP_AMOUNT::STRING,'[^0-9\\.-]',''),38,2)  AS OR_PROP_AMOUNT_N
  FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.BNK_AA_BILL_DETAILS bd, cob
  WHERE COALESCE(TRY_TO_DATE(bd.PAYMENT_DATE::STRING,'YYYY-MM-DD'), bd.MIS_DATE::DATE) = cob.cob_date
    AND UPPER(COALESCE(bd.PAYMENT_TYPE, bd.BILL_TYPE, '')) LIKE 'INTEREST%'
),
bill_gross AS (
  SELECT
    ARRANGEMENT_ID,
    PAYMENT_DATE,
    SUM(CASE WHEN PROPERTY LIKE '%DEPOSITINT%' THEN OR_PROP_AMOUNT_N ELSE 0 END) AS INTEREST_GROSS_AMT
  FROM bill_raw
  GROUP BY 1,2
)
SELECT
  a.ARRANGEMENT_ID,
  a.ACTIVE_PRODUCT AS PRODUCT_ID,
  acc.ALT_ID,
  b.PAYMENT_DATE,
  b.INTEREST_GROSS_AMT
FROM arrangement_base a
LEFT JOIN arr_account_latest acc USING (ARRANGEMENT_ID)
LEFT JOIN bill_gross         b   USING (ARRANGEMENT_ID)
WHERE b.PAYMENT_DATE IS NOT NULL
ORDER BY a.ARRANGEMENT_ID, b.PAYMENT_DATE;
