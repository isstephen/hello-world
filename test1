WITH cob AS (
  SELECT MAX(COB_DAY_DATE) AS cob_date
  FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.V_INT_COB_DAYS
)
SELECT
  bd.ARRANGEMENT_ID,
  -- 原始日期 & 解析后日期
  bd.PAYMENT_DATE        AS PAYMENT_DATE_RAW,
  bd.MIS_DATE            AS MIS_DATE_RAW,
  COALESCE(
    TRY_TO_DATE(TO_VARCHAR(bd.PAYMENT_DATE),'YYYY-MM-DD'),
    TRY_TO_DATE(TO_VARCHAR(bd.PAYMENT_DATE),'YYYYMMDD'),
    TRY_TO_DATE(TO_VARCHAR(bd.MIS_DATE    ),'YYYY-MM-DD'),
    TRY_TO_DATE(TO_VARCHAR(bd.MIS_DATE    ),'YYYYMMDD')
  )                      AS PAYMENT_DATE,
  UPPER(TRIM(COALESCE(bd.PAYMENT_TYPE, bd.BILL_TYPE, ''))) AS PAYMENT_TYPE,
  UPPER(TRIM(bd.PROPERTY))                                  AS PROPERTY,
  bd.OR_PROP_AMOUNT                                         AS OR_PROP_AMOUNT_RAW,
  TRY_TO_DECIMAL(REGEXP_REPLACE(TO_VARCHAR(bd.OR_PROP_AMOUNT),'[^0-9\\.-]',''),38,2) AS OR_PROP_AMOUNT_N,
  bd.OR_TOTAL_AMOUNT                                        AS OR_TOTAL_AMOUNT_RAW,
  TRY_TO_DECIMAL(REGEXP_REPLACE(TO_VARCHAR(bd.OR_TOTAL_AMOUNT),'[^0-9\\.-]',''),38,2) AS OR_TOTAL_AMOUNT_N
FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.BNK_AA_BILL_DETAILS bd, cob
WHERE COALESCE(
        TRY_TO_DATE(TO_VARCHAR(bd.PAYMENT_DATE),'YYYY-MM-DD'),
        TRY_TO_DATE(TO_VARCHAR(bd.PAYMENT_DATE),'YYYYMMDD'),
        TRY_TO_DATE(TO_VARCHAR(bd.MIS_DATE    ),'YYYY-MM-DD'),
        TRY_TO_DATE(TO_VARCHAR(bd.MIS_DATE    ),'YYYYMMDD')
      ) = cob.cob_date
  AND UPPER(TRIM(COALESCE(bd.PAYMENT_TYPE, bd.BILL_TYPE, ''))) LIKE 'INTEREST%'
ORDER BY OR_PROP_AMOUNT_N DESC NULLS LAST
LIMIT 200;





WITH cob AS (
  SELECT MAX(COB_DAY_DATE) AS cob_date
  FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.V_INT_COB_DAYS
)
SELECT
  UPPER(TRIM(bd.PROPERTY)) AS PROPERTY,
  COUNT(*)                 AS ROWS_,
  SUM(TRY_TO_DECIMAL(REGEXP_REPLACE(TO_VARCHAR(bd.OR_PROP_AMOUNT),'[^0-9\\.-]',''),38,2)) AS SUM_PROP_AMT,
  SUM(TRY_TO_DECIMAL(REGEXP_REPLACE(TO_VARCHAR(bd.OR_TOTAL_AMOUNT),'[^0-9\\.-]',''),38,2)) AS SUM_TOTAL_AMT
FROM DB_INVESTMENTS_SYST02.INVESTMENTS_SERVE.BNK_AA_BILL_DETAILS bd, cob
WHERE COALESCE(
        TRY_TO_DATE(TO_VARCHAR(bd.PAYMENT_DATE),'YYYY-MM-DD'),
        TRY_TO_DATE(TO_VARCHAR(bd.PAYMENT_DATE),'YYYYMMDD'),
        TRY_TO_DATE(TO_VARCHAR(bd.MIS_DATE    ),'YYYY-MM-DD'),
        TRY_TO_DATE(TO_VARCHAR(bd.MIS_DATE    ),'YYYYMMDD')
      ) = cob.cob_date
  AND UPPER(TRIM(COALESCE(bd.PAYMENT_TYPE, bd.BILL_TYPE, ''))) LIKE 'INTEREST%'
GROUP BY 1
ORDER BY SUM_PROP_AMT DESC NULLS LAST;




