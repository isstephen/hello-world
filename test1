pipeline {
  agent {
    kubernetes {
      defaultContainer 'inspect'
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: inspect
      image: ${IMAGE}
      imagePullPolicy: Always
      command: ['sleep']
      args: ['99d']
      resources:
        requests:
          cpu: "0.1"
          memory: "128Mi"
        limits:
          cpu: "1"
          memory: "512Mi"
"""
    }
  }

  parameters {
    string(
      name: 'IMAGE',
      defaultValue: '',
      description: 'image:tag'
    )
  }

  options { timestamps() }

  stages {
    stage('Inspect image') {
      steps {
        container('inspect') {
          sh '''#!/bin/bash
set -euo pipefail

REPORT="image_inventory.txt"
: > "$REPORT"

say(){ echo -e "$@" | tee -a "$REPORT"; }

say "=== Image: ${IMAGE:-unknown} ==="
say "\\n== OS ==";          (cat /etc/os-release 2>/dev/null || true) | tee -a "$REPORT"
say "\\n== Kernel ==";       uname -a | tee -a "$REPORT"
say "\\n== PATH ==";         echo "$PATH" | tee -a "$REPORT"

say "\\n== Package manager & sample list =="
if command -v dpkg >/dev/null; then
  say "[Debian/Ubuntu] dpkg present"; dpkg -l | head -n 20 | tee -a "$REPORT"
elif command -v apk >/dev/null; then
  say "[Alpine] apk present"; apk info -vv | head -n 20 | tee -a "$REPORT"
elif command -v rpm >/dev/null; then
  say "[RHEL/CentOS] rpm present"; rpm -qa | head -n 20 | tee -a "$REPORT"
else
  say "No known package manager found"
fi

check(){ # check <bin> [version args...]
  local bin="$1"; shift || true
  if command -v "$bin" >/dev/null 2>&1; then
    say "\\n>> $bin FOUND"
    ("$bin" "$@" 2>&1 | head -n 5) | tee -a "$REPORT" || true
  else
    say "\\n>> $bin not found"
  fi
}

say "\\n== Tools & versions =="
check bash --version
check python3 --version
check pip3 --version
if command -v pip3 >/dev/null; then
  say "\\n>> pip3 list (top 20)"
  pip3 list | head -n 20 | tee -a "$REPORT"
fi
check aws --version
check snowsql -v
check flyway -v
check git --version
check jq --version
check kubectl version --client=true --output=yaml
check helm version
check terraform version

say "\\nReport saved to $REPORT"
cat "$REPORT"
'''
        }
      }
    }
  }

  post {
    success {
      archiveArtifacts artifacts: 'image_inventory.txt', fingerprint: true
    }
  }
}
